- publisher:
    name: default-log-parser
    publishers:
        - logparser:
            parse-rules: '/jenkins-master-data/log_parser_rules.txt'
            unstable-on-warning: false
            fail-on-error: false

- publisher:
    name: default-gcs
    publishers:
        - google-cloud-storage:
            credentials-id: kubernetes-jenkins
            uploads:
                - build-log:
                    log-name: build-log.txt
                    storage-location: gs://kubernetes-jenkins/logs/$JOB_NAME/$BUILD_NUMBER
                    share-publicly: true
                    upload-for-failed-jobs: true

- job-template:
    name: 'kubernetes-upgrade-{version-old}-{version-new}'
    project-type: multijob
    triggers:
        - timed: '@hourly'
    builders:
        - multijob:
            name: Deploy
            projects:
                - name: 'kubernetes-upgrade-{version-old}-{version-new}-step1-deploy'
        - multijob:
            name: Upgrade Master
            projects:
                - name: 'kubernetes-upgrade-{version-old}-{version-new}-step2-upgrade-master'
        - multijob:
            name: Test Old
            projects:
                - name: 'kubernetes-upgrade-{version-old}-{version-new}-step3-e2e-old'
        - multijob:
            name: Upgrade Cluster
            projects:
                - name: 'kubernetes-upgrade-{version-old}-{version-new}-step4-upgrade-cluster'
        - multijob:
            name: Test Old
            projects:
                - name: 'kubernetes-upgrade-{version-old}-{version-new}-step5-e2e-old'
        - multijob:
            name: Test New
            projects:
                - name: 'kubernetes-upgrade-{version-old}-{version-new}-step6-e2e-new'

- job-template:
    name: 'kubernetes-upgrade-{version-old}-{version-new}-{extension}'
    logrotate:
        daysToKeep: 7

    builders:
        - shell: |
            export E2E_PUBLISH_GREEN_VERSION=true
            curl -fsS -o upload-to-gcs.sh --retry 3 "https://raw.githubusercontent.com/kubernetes/kubernetes/{branch-name}/hack/jenkins/upload-to-gcs.sh" && source upload-to-gcs.sh; rm -f upload-to-gcs.sh
            curl -fsS --retry 3  "https://raw.githubusercontent.com/GoogleCloudPlatform/kubernetes/{branch-name}/hack/jenkins/e2e.sh" | bash -

    triggers:
        - timed: 'H/30 * * * *'

    wrappers:
        - ansicolor:
            colormap: xterm
        - timeout:
            timeout: 150
            abort: true
            fail: true
        - timestamps
        - workspace-cleanup

    publishers:
        - claim-build
        - email-ext
        - default-gcs
        - junit:
            results: '_artifacts/junit*.xml'
            keep-long-stdio: true
            health-scale-factor: 100.0
            test-stability: true
            claim-build: true
        - default-log-parser

- project:
    name: upgrade-from-1.0
    version-old: 1.0
    version-new:
        - 1.1
        - master
    extension:
        - 'step1-deploy':
            branch-name: '{version-old}'
        - 'step2-upgrade-master':
            branch-name: '{version-new}'
        - 'step3-e2e-old':
            branch-name: '{version-old}'
        - 'step4-upgrade-cluster':
            branch-name: '{version-new}'
        - 'step5-e2e-old':
            branch-name: '{version-old}'
        - 'step6-e2e-new':
            branch-name: '{version-new}'
    jobs:
        - 'kubernetes-upgrade-{version-old}-{version-new}'
        - 'kubernetes-upgrade-{version-old}-{version-new}-{extension}'
