- publisher:
    name: default-junit-publisher
    publishers:
        - junit:
            results: '_artifacts/junit*.xml'
            keep-long-stdio: true
            health-scale-factor: 100.0
            test-stability: true
            claim-build: true

- publisher:
    name: default-log-parser
    publishers:
        - logparser:
            parse-rules: '/jenkins-master-data/log_parser_rules.txt'
            unstable-on-warning: false
            fail-on-error: false

- publisher:
    name: default-gcs
    publishers:
        - google-cloud-storage:
            credentials-id: kubernetes-jenkins
            uploads:
                - build-log:
                    log-name: build-log.txt
                    storage-location: gs://kubernetes-jenkins/logs/$JOB_NAME/$BUILD_NUMBER
                    share-publicly: true
                    upload-for-failed-jobs: true

# multijob
- job-template:
    name: 'kubernetes-upgrade-gke-{version-old}-{version-new}'
    disabled: false
    description: "Upgrade multijob from {version-old} to {version-new}. WIP, contact ihmccreery@."
    project-type: multijob
    triggers:
        - timed: '@hourly'
    builders:
        # TODO(spxtr) take care of this once we merge these in.
        # - shell: "curl -fsS https://raw.githubusercontent.com/kubernetes/kubernetes/master/hack/jenkins/update-jobs.sh | /bin/bash -s - hack/jenkins/job-configs/upgrades/kubernetes-upgrade-gke-1.0-master"
        - multijob:
            name: Deploy
            projects:
                - name: 'kubernetes-upgrade-gke-{version-old}-{version-new}-step1-deploy'
        - multijob:
            name: Upgrade Master
            projects:
                - name: 'kubernetes-upgrade-gke-{version-old}-{version-new}-step2-upgrade-master'
        - multijob:
            name: Test Old
            projects:
                - name: 'kubernetes-upgrade-gke-{version-old}-{version-new}-step3-e2e-old'
        - multijob:
            name: Upgrade Cluster
            projects:
                - name: 'kubernetes-upgrade-gke-{version-old}-{version-new}-step4-upgrade-cluster'
        - multijob:
            name: Test Old
            projects:
                - name: 'kubernetes-upgrade-gke-{version-old}-{version-new}-step5-e2e-old'
        - multijob:
            name: Test New
            projects:
                - name: 'kubernetes-upgrade-gke-{version-old}-{version-new}-step6-e2e-new'

# actual job except step1-deploy
- job-template:
    name: 'kubernetes-upgrade-gke-{version-old}-{version-new}-{step}'
    workspace: /var/lib/jenkins/jobs/kubernetes-upgrade-gke-{version-old}-{version-new}-step1-deploy/workspace/
    builders:
        - shell: |
            export E2E_PUBLISH_GREEN_VERSION=true
            # GCE_SERVICE_ACCOUNT
            curl -fsS -o upload-to-gcs.sh --retry 3 "https://raw.githubusercontent.com/kubernetes/kubernetes/master/hack/jenkins/upload-to-gcs.sh" && source upload-to-gcs.sh; rm -f upload-to-gcs.sh
            curl -fsS --retry 3  "https://raw.githubusercontent.com/GoogleCloudPlatform/kubernetes/{branch-name}/hack/jenkins/e2e.sh" | bash -
    logrotate:
        daysToKeep: 7
    wrappers:
        - ansicolor:
            colormap: xterm
        - timeout:
            timeout: 150
            abort: true
            fail: true
        - timestamps
        - workspace-cleanup
    publishers:
        - claim-build
        - email-ext
        - default-gcs
        - default-log-parser
        - default-junit-publisher

# actual job for step1-deploy
- job-template:
    name: 'kubernetes-upgrade-gke-{version-old}-{version-new}-step1-deploy'
    builders:
        - shell: |
            export E2E_PUBLISH_GREEN_VERSION=true
            # GCE_SERVICE_ACCOUNT
            curl -fsS -o upload-to-gcs.sh --retry 3 "https://raw.githubusercontent.com/kubernetes/kubernetes/master/hack/jenkins/upload-to-gcs.sh" && source upload-to-gcs.sh; rm -f upload-to-gcs.sh
            curl -fsS --retry 3  "https://raw.githubusercontent.com/GoogleCloudPlatform/kubernetes/{branch-name}/hack/jenkins/e2e.sh" | bash -
    logrotate:
        daysToKeep: 7
    wrappers:
        - ansicolor:
            colormap: xterm
        - timeout:
            timeout: 150
            abort: true
            fail: true
        - timestamps
        - workspace-cleanup
    publishers:
        - claim-build
        - email-ext
        - default-gcs
        - default-log-parser
